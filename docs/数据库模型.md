# 数据库模型

## 数据库概述

Project Heimdall 使用 PostgreSQL 作为主数据库，采用 SQLAlchemy ORM 进行数据操作。数据库设计遵循第三范式，支持高并发读写操作，包含完整的用户行为追踪、意图分析、广告推荐等核心业务数据。

## 数据库架构图

```
PostgreSQL
├── 用户相关表
│   ├── user_profiles          # 用户画像信息
│   ├── user_sessions          # 用户会话信息
│   └── user_behaviors         # 用户行为记录
├── 内容相关表
│   ├── product_categories     # 产品分类
│   └── products              # 产品信息
├── 广告相关表
│   ├── ads                   # 广告信息
│   └── ad_recommendations    # 广告推荐记录
├── 分析相关表
│   ├── intent_analyses       # 意图分析结果
│   └── recommendations        # 推荐结果
├── 会话相关表
│   ├── chat_sessions         # 聊天会话
│   └── chat_messages         # 聊天消息
└── 系统相关表
    ├── ab_tests              # A/B测试
    └── schema_migrations     # 数据库版本管理
```

## 核心数据模型详解

### 1. 用户相关表

#### user_profiles (用户画像表)
```sql
CREATE TABLE user_profiles (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(255),
    email VARCHAR(255),
    age INTEGER,
    gender VARCHAR(20),
    location VARCHAR(255),
    interests TEXT[],
    membership_level VARCHAR(50) DEFAULT 'standard',
    activity_level INTEGER DEFAULT 0,
    price_range_min DECIMAL(10,2) DEFAULT 0,
    price_range_max DECIMAL(10,2) DEFAULT 0,
    preferences JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `user_id`: 用户唯一标识符
- `membership_level`: 会员等级 (standard/premium/vip)
- `activity_level`: 活跃度评分 (0-100)
- `price_range_min/max`: 价格偏好区间
- `preferences`: 用户偏好设置 (JSON格式)
- `interests`: 兴趣标签数组

**索引设计：**
```sql
CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
CREATE INDEX idx_user_profiles_membership_level ON user_profiles(membership_level);
CREATE INDEX idx_user_profiles_activity_level ON user_profiles(activity_level);
```

#### user_sessions (用户会话表)
```sql
CREATE TABLE user_sessions (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(255) UNIQUE NOT NULL,
    user_id VARCHAR(255),
    ip_address VARCHAR(45),
    user_agent TEXT,
    device_type VARCHAR(50),
    location VARCHAR(255),
    metadata JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP WITH TIME ZONE,
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `session_id`: 会话唯一标识
- `device_type`: 设备类型 (mobile/desktop/tablet)
- `metadata`: 会话元数据 (浏览器信息、屏幕分辨率等)
- `expires_at`: 会话过期时间

#### user_behaviors (用户行为表)
```sql
CREATE TABLE user_behaviors (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    session_id VARCHAR(255),
    behavior_type VARCHAR(50) NOT NULL,
    behavior_data JSONB,
    timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `behavior_type`: 行为类型 (view/search/click/purchase)
- `behavior_data`: 行为详细数据 (JSON格式)
- `timestamp`: 行为发生时间

**行为数据示例：**
```json
// 搜索行为
{
  "query": "iPhone 15 Pro",
  "category": "电子产品",
  "filters": {"price_range": "5000-10000", "brand": "Apple"}
}

// 浏览行为
{
  "product_id": 1,
  "duration": 120,
  "scroll_depth": 0.8
}

// 点击行为
{
  "target_type": "ad",
  "target_id": 1,
  "position": 1
}
```

### 2. 内容相关表

#### product_categories (产品分类表)
```sql
CREATE TABLE product_categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    parent_id INTEGER REFERENCES product_categories(id) ON DELETE SET NULL,
    attributes JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `parent_id`: 父分类ID，支持多级分类
- `attributes`: 分类属性 (JSON格式)

#### products (产品信息表)
```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    category VARCHAR(255),
    category_id INTEGER REFERENCES product_categories(id),
    brand VARCHAR(255),
    image_url VARCHAR(500),
    attributes JSONB,
    tags TEXT[],
    rating DECIMAL(3,2) DEFAULT 0,
    review_count INTEGER DEFAULT 0,
    stock_quantity INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `rating`: 产品评分 (0-5)
- `tags`: 产品标签数组
- `attributes`: 产品扩展属性 (JSON格式)
- `stock_quantity`: 库存数量

### 3. 广告相关表

#### ads (广告信息表)
```sql
CREATE TABLE ads (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    image_url VARCHAR(500),
    target_url VARCHAR(500),
    category VARCHAR(255),
    budget DECIMAL(10,2) DEFAULT 0,
    daily_budget DECIMAL(10,2) DEFAULT 0,
    start_date TIMESTAMP WITH TIME ZONE,
    end_date TIMESTAMP WITH TIME ZONE,
    targeting JSONB,
    attributes JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `budget`: 总预算
- `daily_budget`: 日预算限制
- `targeting`: 目标受众设置 (JSON格式)
- `attributes`: 广告扩展属性

**目标受众配置示例：**
```json
{
  "age_range": [25, 45],
  "gender": ["male", "female"],
  "locations": ["北京", "上海", "广州"],
  "interests": ["电子产品", "运动"],
  "membership_levels": ["premium", "vip"]
}
```

#### ad_recommendations (广告推荐表)
```sql
CREATE TABLE ad_recommendations (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    session_id VARCHAR(255),
    ad_id INTEGER REFERENCES ads(id) ON DELETE CASCADE,
    score DECIMAL(5,4),
    reason TEXT,
    context JSONB,
    shown BOOLEAN DEFAULT false,
    clicked BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `score`: 推荐分数 (0-1)
- `reason`: 推荐理由说明
- `context`: 推荐上下文信息
- `shown/clicked`: 展示和点击状态跟踪

### 4. 分析相关表

#### intent_analyses (意图分析表)
```sql
CREATE TABLE intent_analyses (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    session_id VARCHAR(255),
    input_text TEXT NOT NULL,
    intent_type VARCHAR(100),
    confidence_score DECIMAL(5,4),
    entities JSONB,
    analysis_result JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `input_text`: 用户输入文本
- `intent_type`: 意图类型
- `confidence_score`: 置信度分数
- `entities`: 提取的实体信息
- `analysis_result`: 完整分析结果

**实体信息示例：**
```json
{
  "product": "iPhone 15 Pro",
  "brand": "Apple",
  "category": "手机",
  "price_range": {"min": 7000, "max": 9000},
  "features": ["5G", "A17芯片", "摄像头"]
}
```

#### recommendations (推荐结果表)
```sql
CREATE TABLE recommendations (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    session_id VARCHAR(255),
    recommendation_type VARCHAR(50),
    recommended_items JSONB,
    scores JSONB,
    algorithm_used VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `recommendation_type`: 推荐类型 (product/ad/content)
- `recommended_items`: 推荐项目列表
- `scores`: 各项评分详情
- `algorithm_used`: 使用的算法名称

### 5. 会话相关表

#### chat_sessions (聊天会话表)
```sql
CREATE TABLE chat_sessions (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(255) UNIQUE NOT NULL,
    system_prompt TEXT,
    user_id VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### chat_messages (聊天消息表)
```sql
CREATE TABLE chat_messages (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `role`: 消息角色 (user/assistant/system/tool)
- `content`: 消息内容 (支持Markdown格式)

### 6. 系统相关表

#### ab_tests (A/B测试表)
```sql
CREATE TABLE ab_tests (
    id SERIAL PRIMARY KEY,
    test_name VARCHAR(255) NOT NULL,
    variant VARCHAR(100) NOT NULL,
    user_id VARCHAR(255),
    session_id VARCHAR(255),
    metrics JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### schema_migrations (数据库版本管理表)
```sql
CREATE TABLE schema_migrations (
    version VARCHAR(50) PRIMARY KEY,
    applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    description TEXT
);
```

## 数据关系设计

### 1. 主要关系图
```
user_profiles (1) ── (N) user_sessions
    │                    │
    │                    │
    │                    ▼
    │              user_behaviors
    │                    │
    │                    │
    ▼                    ▼
intent_analyses ── ad_recommendations
    │                    │
    │                    │
    ▼                    ▼
recommendations ────── ads
    │                    │
    │                    │
    ▼                    ▼
products ────── product_categories
```

### 2. 关键关系说明

#### 用户-行为关系
- 一个用户可以有多个会话
- 一个会话包含多个行为记录
- 行为记录关联到具体的用户和会话

#### 意图-推荐关系
- 意图分析结果生成推荐建议
- 推荐结果包含产品和广告推荐
- 广告推荐跟踪展示和点击效果

#### 产品-分类关系
- 产品属于特定分类
- 分类支持多级层级结构
- 分类属性影响产品推荐

## 性能优化设计

### 1. 索引策略
```sql
-- 用户相关索引
CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
CREATE INDEX idx_user_behaviors_user_id ON user_behaviors(user_id);
CREATE INDEX idx_user_behaviors_session_id ON user_behaviors(session_id);

-- 时间相关索引
CREATE INDEX idx_user_behaviors_timestamp ON user_behaviors(timestamp);
CREATE INDEX idx_intent_analyses_created_at ON intent_analyses(created_at);

-- 业务相关索引
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_ads_category ON ads(category);
CREATE INDEX idx_ad_recommendations_score ON ad_recommendations(score);
```

### 2. 分区策略
- **时间分区**: 用户行为表按时间范围分区
- **用户分区**: 推荐结果表按用户ID哈希分区
- **业务分区**: 广告数据按业务类型分区

### 3. 缓存策略
- **热点数据**: 用户画像、产品信息缓存
- **计算结果**: 推荐算法结果缓存
- **会话数据**: 用户会话状态缓存

## 数据安全设计

### 1. 敏感数据保护
- **用户隐私**: 个人信息加密存储
- **行为数据**: 脱敏处理和访问控制
- **商业数据**: 广告主数据权限隔离

### 2. 访问控制
- **角色权限**: 基于角色的数据访问控制
- **数据脱敏**: 查询结果自动脱敏
- **审计日志**: 完整的数据访问审计

### 3. 数据备份
- **定期备份**: 每日完整备份
- **增量备份**: 实时增量备份
- **异地备份**: 异地容灾备份

## 监控和维护

### 1. 性能监控
- **查询性能**: 慢查询监控和优化
- **连接池**: 数据库连接池状态监控
- **存储空间**: 磁盘空间使用监控

### 2. 数据质量
- **完整性**: 数据完整性检查
- **一致性**: 数据一致性验证
- **准确性**: 数据准确性校验

### 3. 扩展性考虑
- **读写分离**: 支持主从复制
- **分库分表**: 支持水平扩展
- **缓存层**: 多级缓存架构