# 项目依赖关系

## 依赖概述

Project Heimdall 采用现代化的Python技术栈，基于FastAPI构建企业级AI意图广告引擎。项目依赖按照功能模块进行组织，确保系统的可维护性、可扩展性和安全性。

## 依赖关系图

```
Project Heimdall
├── 核心框架层
│   ├── FastAPI (Web框架)
│   ├── Uvicorn (ASGI服务器)
│   └── Starlette (底层框架)
├── 数据处理层
│   ├── SQLAlchemy (ORM)
│   ├── asyncpg (PostgreSQL驱动)
│   └── Alembic (数据库迁移)
├── AI集成层
│   └── OpenAI (AI模型接口)
├── 安全认证层
│   ├── python-jose (JWT处理)
│   ├── passlib (密码加密)
│   └── PyJWT (JWT库)
├── 配置管理层
│   ├── pydantic (数据验证)
│   └── pydantic-settings (配置管理)
├── 缓存和性能层
│   ├── redis (缓存服务)
│   ├── cachetools (缓存工具)
│   └── uvloop (事件循环优化)
├── 监控和日志层
│   ├── structlog (结构化日志)
│   ├── opentelemetry (分布式追踪)
│   └── prometheus-client (指标收集)
├── HTTP客户端层
│   └── httpx (异步HTTP客户端)
├── 开发工具层
│   ├── pytest (测试框架)
│   ├── black (代码格式化)
│   ├── ruff (代码检查)
│   └── mypy (类型检查)
└── 系统工具层
    ├── python-dotenv (环境变量)
    ├── pyyaml (YAML处理)
    └── aiofiles (异步文件操作)
```

## 核心依赖详解

### 1. Web框架依赖

#### FastAPI (0.104.1)
```python
# 主要功能
- 现代异步Web框架
- 自动API文档生成
- 依赖注入系统
- 数据验证和序列化
- 类型提示支持

# 使用场景
- API路由定义
- 请求响应处理
- 中间件配置
- 依赖注入管理
```

**关键特性：**
- 高性能异步处理
- 自动OpenAPI文档
- 内置数据验证
- 完善的类型支持

#### Uvicorn (0.24.0)
```python
# 主要功能
- ASGI服务器实现
- 高性能HTTP服务器
- 支持HTTP/1.1和WebSocket
- 进程管理功能

# 使用场景
- 应用程序启动
- 开发服务器
- 生产环境部署
```

### 2. 数据库依赖

#### SQLAlchemy (2.0.23)
```python
# 主要功能
- Python SQL工具包
- 对象关系映射(ORM)
- 数据库连接池
- 事务管理

# 使用场景
- 数据模型定义
- 数据库操作封装
- 查询构建
- 事务处理
```

**核心模型：**
```python
# 数据模型定义
from sqlalchemy import Column, Integer, String, Text, DateTime, Float, JSON
from src.heimdall.core.database import Base

class UserProfile(Base):
    __tablename__ = "user_profiles"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(255), unique=True, index=True)
    # ... 其他字段定义
```

#### asyncpg (0.29.0)
```python
# 主要功能
- 高性能PostgreSQL驱动
- 异步操作支持
- 连接池管理
- 二进制数据传输

# 使用场景
- 异步数据库连接
- 高并发查询处理
- 连接池优化
```

#### Alembic (1.13.1)
```python
# 主要功能
- 数据库迁移工具
- 版本控制管理
- 自动迁移生成
- 回滚支持

# 使用场景
- 数据库schema变更
- 版本管理
- 团队协作开发
```

### 3. AI集成依赖

#### OpenAI (1.3.7)
```python
# 主要功能
- OpenAI API客户端
- 多模型支持
- 异步调用
- 流式响应

# 使用场景
- 意图分析调用
- 对话生成
- 文本处理
- 模型管理
```

**集成示例：**
```python
import openai
from src.heimdall.core.config import settings

class IntentAnalysisService:
    def __init__(self):
        self.client = openai.AsyncOpenAI(
            api_key=settings.QWEN_API_KEY,
            base_url=settings.QWEN_BASE_URL
        )
    
    async def analyze_intent(self, text: str) -> IntentAnalysis:
        response = await self.client.chat.completions.create(
            model="qwen-turbo",
            messages=[{"role": "user", "content": text}],
            temperature=0.1
        )
        # 处理响应结果
```

### 4. 安全认证依赖

#### python-jose (3.3.0)
```python
# 主要功能
- JWT令牌处理
- 多种加密算法支持
- 令牌验证和生成
- 密钥管理

# 使用场景
- 用户认证
- API访问控制
- 令牌刷新
```

#### passlib (1.7.4)
```python
# 主要功能
- 密码哈希加密
- 多种加密算法
- 安全密码存储
- 密码验证

# 使用场景
- 用户密码加密
- 密码验证
- 安全存储
```

#### PyJWT (2.8.0)
```python
# 主要功能
- JWT令牌编码解码
- 签名验证
- 声明处理
- 过期时间管理

# 使用场景
- JWT令牌处理
- 认证信息传递
- API安全
```

### 5. 配置管理依赖

#### pydantic (2.5.0)
```python
# 主要功能
- 数据验证和序列化
- 类型提示支持
- 配置管理
- JSON处理

# 使用场景
- API模型定义
- 配置对象
- 数据验证
- 类型安全
```

**配置示例：**
```python
from pydantic import BaseSettings, Field
from typing import Optional

class Settings(BaseSettings):
    # 数据库配置
    DATABASE_URL: str = Field(..., env="DATABASE_URL")
    
    # AI模型配置
    QWEN_API_KEY: str = Field(..., env="QWEN_API_KEY")
    QWEN_BASE_URL: str = Field(..., env="QWEN_BASE_URL")
    
    # 安全配置
    SECRET_KEY: str = Field(..., env="SECRET_KEY")
    
    # Redis配置
    REDIS_URL: str = Field(..., env="REDIS_URL")
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
```

#### pydantic-settings (2.1.0)
```python
# 主要功能
- 环境变量管理
- 配置文件读取
- 类型验证
- 默认值设置

# 使用场景
- 应用配置管理
- 环境变量处理
- 配置验证
```

### 6. 缓存和性能依赖

#### redis (5.0.1)
```python
# 主要功能
- 内存数据存储
- 高性能缓存
- 数据结构支持
- 持久化选项

# 使用场景
- 会话管理
- 缓存热点数据
- 限流计数器
- 消息队列
```

**缓存示例：**
```python
import redis
from src.heimdall.core.config import settings

class CacheService:
    def __init__(self):
        self.redis_client = redis.from_url(settings.REDIS_URL)
    
    async def get_user_profile(self, user_id: str):
        cache_key = f"user_profile:{user_id}"
        cached_data = self.redis_client.get(cache_key)
        
        if cached_data:
            return json.loads(cached_data)
        
        # 从数据库获取数据
        profile = await self.user_repository.get_by_id(user_id)
        
        # 缓存数据
        self.redis_client.setex(
            cache_key, 
            3600,  # 1小时过期
            json.dumps(profile.dict())
        )
        
        return profile
```

#### cachetools (5.3.2)
```python
# 主要功能
- 内存缓存工具
- 多种缓存策略
- 过期时间管理
- 缓存统计

# 使用场景
- 函数结果缓存
- 计算结果缓存
- 临时数据存储
```

#### uvloop (0.19.0)
```python
# 主要功能
- 高性能事件循环
- libuv集成
- 异步IO优化
- 性能提升

# 使用场景
- 事件循环替换
- 性能优化
- 高并发处理
```

### 7. 监控和日志依赖

#### structlog (23.2.0)
```python
# 主要功能
- 结构化日志
- 日志格式化
- 上下文信息
- 性能优化

# 使用场景
- 应用日志记录
- 调试信息
- 错误追踪
- 性能监控
```

**日志配置示例：**
```python
import structlog
import logging

# 配置structlog
structlog.configure(
    processors=[
        structlog.stdlib.filter_by_level,
        structlog.stdlib.add_logger_name,
        structlog.stdlib.add_log_level,
        structlog.stdlib.PositionalArgumentsFormatter(),
        structlog.processors.TimeStamper(fmt="iso"),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.UnicodeDecoder(),
        structlog.processors.JSONRenderer()
    ],
    context_class=dict,
    logger_factory=structlog.stdlib.LoggerFactory(),
    wrapper_class=structlog.stdlib.BoundLogger,
    cache_logger_on_first_use=True,
)

# 使用示例
logger = structlog.get_logger()
logger.info("用户登录成功", user_id="user_123", ip_address="192.168.1.1")
```

#### opentelemetry (1.36.0)
```python
# 主要功能
- 分布式追踪
- 性能监控
- 指标收集
- 上下文传播

# 使用场景
- 请求追踪
- 性能分析
- 错误追踪
- 系统监控
```

#### prometheus-client (0.19.0)
```python
# 主要功能
- Prometheus指标
- 性能指标收集
- 指标暴露
- 监控数据

# 使用场景
- 业务指标监控
- 性能指标收集
- 健康检查
- 告警触发
```

### 8. HTTP客户端依赖

#### httpx (0.25.2)
```python
# 主要功能
- 异步HTTP客户端
- 请求响应处理
- 连接池管理
- 超时控制

# 使用场景
- 外部API调用
- 微服务通信
- 文件上传下载
- 代理支持
```

**HTTP客户端示例：**
```python
import httpx
from src.heimdall.core.config import settings

class ExternalAPIService:
    def __init__(self):
        self.client = httpx.AsyncClient(
            timeout=30.0,
            limits=httpx.Limits(max_connections=100)
        )
    
    async def call_external_api(self, url: str, data: dict):
        try:
            response = await self.client.post(
                url,
                json=data,
                headers={"Authorization": f"Bearer {settings.API_TOKEN}"}
            )
            response.raise_for_status()
            return response.json()
        except httpx.HTTPError as e:
            logger.error("外部API调用失败", error=str(e))
            raise
```

## 开发依赖详解

### 1. 测试框架

#### pytest (7.4.3)
```python
# 主要功能
- 测试框架
- 断言机制
- 测试发现
- 插件支持

# 使用场景
- 单元测试
- 集成测试
- API测试
- 性能测试
```

#### pytest-asyncio (0.21.1)
```python
# 主要功能
- 异步测试支持
- 事件循环管理
- 异步fixture
- 并发测试

# 使用场景
- 异步函数测试
- 协程测试
- 异步上下文测试
```

#### pytest-cov (4.1.0)
```python
# 主要功能
- 代码覆盖率
- 测试覆盖率报告
- 覆盖率配置
- HTML报告生成

# 使用场景
- 代码质量检查
- 测试完整性验证
- 覆盖率统计
```

### 2. 代码质量工具

#### black (23.11.0)
```python
# 主要功能
- 代码格式化
- 统一代码风格
- 自动格式化
- 配置灵活

# 使用场景
- 代码格式统一
- 团队协作
- 代码审查
- CI/CD流程
```

#### ruff (0.1.6)
```python
# 主要功能
- 快速代码检查
- 语法检查
- 代码风格检查
- 性能优化建议

# 使用场景
- 代码质量检查
- 语法错误检测
- 性能问题识别
- 安全漏洞检查
```

#### mypy (1.7.1)
```python
# 主要功能
- 静态类型检查
- 类型提示验证
- 类型错误检测
- 类型推断

# 使用场景
- 类型安全检查
- 代码质量保证
- IDE支持
- 重构辅助
```

## 依赖版本管理

### 1. 版本锁定策略
```python
# 生产环境依赖 - 精确版本
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23

# 开发环境依赖 - 灵活版本
pytest>=7.4.3
black>=23.11.0
ruff>=0.1.6
```

### 2. 依赖分组管理
```python
# pyproject.toml 配置
[project.optional-dependencies]
dev = [
    "pytest>=7.4.3",
    "pytest-asyncio>=0.21.1",
    "pytest-cov>=4.1.0",
    "black>=23.11.0",
    "ruff>=0.1.6",
    "mypy>=1.7.1"
]
test = [
    "pytest>=7.4.3",
    "pytest-asyncio>=0.21.1",
    "pytest-cov>=4.1.0",
    "httpx>=0.25.2"
]
mcp = [
    "mcp>=1.0.0"
]
```

### 3. 安全更新策略
```python
# 定期安全更新
- 每月检查依赖安全漏洞
- 使用 pip-audit 工具扫描
- 及时更新有安全问题的依赖
- 测试兼容性后升级
```

## 依赖优化策略

### 1. 性能优化
```python
# 异步优先
- 选择异步版本的库
- 避免阻塞操作
- 使用连接池
- 优化内存使用
```

### 2. 内存优化
```python
# 资源管理
- 使用对象池
- 及时释放资源
- 避免内存泄漏
- 监控内存使用
```

### 3. 启动优化
```python
# 懒加载
- 延迟初始化
- 按需导入
- 减少启动依赖
- 优化导入顺序
```

## 依赖问题排查

### 1. 常见问题
```python
# 版本冲突
- 使用 pip check 检查
- 解决依赖冲突
- 使用虚拟环境隔离

# 性能问题
- 分析依赖性能
- 替换低效库
- 优化配置参数

# 兼容性问题
- 检查Python版本兼容性
- 测试不同环境
- 使用兼容性层
```

### 2. 调试工具
```python
# 依赖分析工具
- pipdeptree (依赖树)
- pip-audit (安全检查)
- pip-compile (依赖锁定)
- pip-tools (依赖管理)
```

## 最佳实践

### 1. 依赖管理
```python
# 使用requirements.txt
- 明确版本号
- 分类管理依赖
- 定期更新依赖
- 安全扫描检查
```

### 2. 虚拟环境
```python
# 环境隔离
- 每个项目独立环境
- 使用 .venv 目录
- 配置 .gitignore
- 文档说明环境设置
```

### 3. 持续集成
```python
# CI/CD集成
- 自动化测试
- 依赖安全检查
- 代码质量检查
- 自动化部署
```

## 依赖监控

### 1. 监控指标
```python
# 依赖健康度
- 依赖更新频率
- 安全漏洞数量
- 兼容性问题
- 性能影响
```

### 2. 告警机制
```python
# 自动告警
- 安全漏洞告警
- 版本过期告警
- 性能问题告警
- 兼容性问题告警
```